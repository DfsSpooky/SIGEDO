{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Reserva de Equipo{% endblock %}

{% block extra_css %}
<style>
    .timeline-container {
        position: relative;
        background-color: #f9fafb; /* gray-50 */
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #e5e7eb; /* gray-200 */
        max-height: 400px;
        overflow-y: auto;
    }
    .timeline-slots {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .timeline-shift-header {
        font-weight: bold;
        font-size: 1.1rem;
        padding: 1rem 0 0.5rem;
        position: sticky;
        top: -1rem; /* Stick to the top of the container */
        background-color: #f9fafb; /* gray-50 */
        z-index: 10;
        text-transform: capitalize;
    }
    .timeline-slot {
        height: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 1rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s;
        cursor: pointer;
    }
    .timeline-slot .time-text {
        font-weight: 500;
        color: #374151; /* gray-700 */
    }
    .timeline-slot.available:hover {
        background-color: #dbeafe; /* blue-100 */
    }
    .timeline-slot.reserved {
        background-color: #f3f4f6; /* gray-100 */
        cursor: not-allowed;
    }
    .timeline-slot.reserved .time-text {
        text-decoration: line-through;
        color: #9ca3af; /* gray-400 */
    }
    .timeline-slot.selected {
        background-color: #2563eb !important; /* blue-600 */
        color: white;
    }
    .timeline-slot.in-range {
        background-color: #60a5fa; /* blue-400 */
        color: white;
    }
    .timeline-slot.in-range .time-text, .timeline-slot.selected .time-text {
        color: white;
    }
    .step-content {
        min-height: 300px; /* Evita saltos de layout */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold">Nueva Reserva</h1>
                <p class="text-base-content/70 mt-2">Sigue los pasos para reservar un equipo.</p>
            </div>

            <!-- Indicador de Pasos -->
            <ul class="steps w-full mb-10" id="steps-indicator">
                <li class="step step-primary" data-step="1">Tipo de Equipo</li>
                <li class="step" data-step="2">Equipo y Fecha</li>
                <li class="step" data-step="3">Horario</li>
                <li class="step" data-step="4">Confirmar</li>
            </ul>

            <!-- Contenedor de Pasos -->
            <div id="steps-container">
                <!-- Paso 1: Seleccionar Tipo de Activo -->
                <div id="step-1" class="step-content">
                    <h3 class="text-xl font-semibold text-center mb-4">¿Qué tipo de equipo necesitas?</h3>
                    <div id="tipo-activo-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- Los tipos de activo se cargarán aquí con JS -->
                        <div class="text-center p-4"><span class="loading loading-spinner loading-lg"></span></div>
                    </div>
                </div>

                <!-- Paso 2: Seleccionar Activo y Fecha -->
                <div id="step-2" class="step-content hidden">
                    <h3 class="text-xl font-semibold text-center mb-4">Elige el equipo específico y la fecha</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <label for="activo-list" class="label">Equipo disponible:</label>
                            <div id="activo-list" class="flex flex-col gap-2">
                                <!-- Los activos se cargarán aquí con JS -->
                                <div class="text-center p-4"><span class="loading loading-spinner"></span></div>
                            </div>
                        </div>
                        <div>
                            <label for="fecha-reserva" class="label">Fecha de la reserva:</label>
                            <input type="date" id="fecha-reserva" name="fecha" class="input input-bordered w-full">
                        </div>
                    </div>
                </div>

                <!-- Paso 3: Seleccionar Horario -->
                <div id="step-3" class="step-content hidden">
                    <div class="text-center mb-4">
                        <h3 class="text-xl font-semibold">Selecciona un rango horario</h3>
                        <p id="timeline-instructions" class="text-sm text-base-content/60 mt-1">Haz clic en la hora de inicio.</p>
                    </div>
                    <div id="timeline-container" class="timeline-container">
                        <div id="timeline-slots" class="timeline-slots">
                            <!-- Las franjas horarias se cargarán aquí con JS -->
                            <div class="text-center p-4"><span class="loading loading-spinner loading-lg"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Paso 4: Confirmación -->
                <div id="step-4" class="step-content hidden">
                    <h3 class="text-xl font-semibold text-center mb-6">Confirma tu reserva</h3>
                    <div id="reserva-summary" class="card bg-base-200">
                        <div class="card-body">
                            <h4 class="card-title">Resumen de la Reserva</h4>
                            <p><strong>Equipo:</strong> <span id="summary-activo"></span></p>
                            <p><strong>Fecha:</strong> <span id="summary-fecha"></span></p>
                            <p><strong>Horario:</strong> <span id="summary-horario"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navegación de Pasos -->
        <div class="bg-base-200/50 px-8 py-4">
            <div class="flex justify-between">
                <button id="prev-btn" class="btn btn-ghost" disabled>
                    <i class="fas fa-arrow-left mr-2"></i> Anterior
                </button>
                <button id="next-btn" class="btn btn-primary" disabled>
                    Siguiente <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button id="submit-btn" class="btn btn-success hidden">
                    <i class="fas fa-check mr-2"></i> Confirmar Reserva
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE MANAGEMENT ---
    const state = {
        currentStep: 1,
        tipoActivo: null,
        activo: null,
        fecha: '',
        franjaInicio: null,
        franjaFin: null,
    };

    // --- DOM ELEMENTS ---
    const steps = {
        1: document.getElementById('step-1'),
        2: document.getElementById('step-2'),
        3: document.getElementById('step-3'),
        4: document.getElementById('step-4'),
    };
    const stepIndicators = document.querySelectorAll('#steps-indicator .step');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const tipoActivoList = document.getElementById('tipo-activo-list');
    const activoList = document.getElementById('activo-list');
    const fechaInput = document.getElementById('fecha-reserva');
    const timelineSlots = document.getElementById('timeline-slots');
    const timelineInstructions = document.getElementById('timeline-instructions');

    // --- API HELPERS ---
    const api = {
        getTiposActivo: () => fetch("{% url 'api:lista_tipos_activo' %}").then(res => res.json()),
        getActivos: (tipoId) => fetch(`{% url 'api:lista_activos' %}?tipo_id=${tipoId}`).then(res => res.json()),
        getDisponibilidad: (activoId, fecha) => fetch(`{% url 'api:disponibilidad_activo' %}?activo_id=${activoId}&fecha=${fecha}`).then(res => res.json()),
        createReserva: (data) => fetch("{% url 'api:crear_reserva' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(data)
        }).then(res => res.json()),
    };

    // --- RENDER FUNCTIONS ---
    const render = {
        tiposActivo: (tipos) => {
            tipoActivoList.innerHTML = tipos.map(tipo => `
                <div class="card bg-base-200 hover:bg-primary hover:text-primary-content transition-all cursor-pointer" data-id="${tipo.id}">
                    <div class="card-body items-center text-center">
                        <h2 class="card-title">${tipo.nombre}</h2>
                    </div>
                </div>
            `).join('');
        },
        activos: (activos) => {
            activoList.innerHTML = activos.length ? activos.map(activo => `
                <div class="p-2 border rounded-lg hover:bg-base-200 cursor-pointer" data-id="${activo.id}" data-nombre="${activo.nombre}">
                    ${activo.nombre}
                </div>
            `).join('') : '<p class="text-sm text-base-content/60">No hay equipos de este tipo.</p>';
        },
        timeline: (disponibilidad) => {
            let html = '';
            const turnos = {'MANANA': 'Mañana', 'TARDE': 'Tarde', 'NOCHE': 'Noche'};

            for (const [turno, nombreTurno] of Object.entries(turnos)) {
                const franjas = disponibilidad[turno];
                if (franjas && franjas.length > 0) {
                    html += `<div class="timeline-shift-header">${nombreTurno}</div>`;
                    html += franjas.map(f => {
                        const time = f.hora_inicio.slice(0, 5);
                        return `
                        <div class="timeline-slot ${f.is_reservado ? 'reserved' : 'available'}" data-id="${f.id}" data-time="${time}">
                            <span class="time-text">${time}</span>
                            ${f.is_reservado ? '<span>Reservado</span>' : ''}
                        </div>
                    `}).join('');
                }
            }
            timelineSlots.innerHTML = html || '<p class="text-center text-base-content/60">No hay horarios disponibles para este día.</p>';
        },
        summary: () => {
            document.getElementById('summary-activo').textContent = state.activo.nombre;
            document.getElementById('summary-fecha').textContent = new Date(state.fecha + 'T00:00:00').toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            const horaFinDate = new Date(`1970-01-01T${state.franjaFin.time}`);
            horaFinDate.setMinutes(horaFinDate.getMinutes() + 30); // Asumiendo franjas de 30 min para mostrar fin
            const horaFinStr = horaFinDate.toTimeString().slice(0,5);

            document.getElementById('summary-horario').textContent = `${state.franjaInicio.time} - ${horaFinStr}`;
        }
    };

    // --- UI & STEP LOGIC ---
    function updateButtons() {
        prevBtn.disabled = state.currentStep === 1;
        nextBtn.classList.toggle('hidden', state.currentStep === 4);
        submitBtn.classList.toggle('hidden', state.currentStep !== 4);

        let nextEnabled = false;
        if (state.currentStep === 1 && state.tipoActivo) nextEnabled = true;
        if (state.currentStep === 2 && state.activo && state.fecha) nextEnabled = true;
        if (state.currentStep === 3 && state.franjaInicio && state.franjaFin) nextEnabled = true;
        nextBtn.disabled = !nextEnabled;
    }

    function goToStep(step) {
        state.currentStep = step;
        Object.values(steps).forEach(el => el.classList.add('hidden'));
        steps[step].classList.remove('hidden');

        stepIndicators.forEach((indicator, i) => {
            indicator.classList.remove('step-primary');
            if (i < step) indicator.classList.add('step-primary');
            if (i + 1 === step) indicator.classList.add('step-primary');
        });
        updateButtons();
    }

    // --- EVENT HANDLERS ---
    tipoActivoList.addEventListener('click', e => {
        const card = e.target.closest('.card');
        if (!card) return;
        state.tipoActivo = { id: card.dataset.id, nombre: card.querySelector('.card-title').textContent };
        document.querySelectorAll('#tipo-activo-list .card').forEach(c => c.classList.remove('bg-primary', 'text-primary-content'));
        card.classList.add('bg-primary', 'text-primary-content');
        updateButtons();
    });

    activoList.addEventListener('click', e => {
        const item = e.target.closest('[data-id]');
        if (!item) return;
        state.activo = { id: item.dataset.id, nombre: item.dataset.nombre };
        document.querySelectorAll('#activo-list [data-id]').forEach(i => i.classList.remove('bg-primary', 'text-primary-content'));
        item.classList.add('bg-primary', 'text-primary-content');
        updateButtons();
    });

    fechaInput.addEventListener('change', () => {
        state.fecha = fechaInput.value;
        updateButtons();
    });

    timelineSlots.addEventListener('click', e => {
        const slot = e.target.closest('.timeline-slot.available');
        if (!slot) return;

        if (!state.franjaInicio || state.franjaFin) {
            // Start new selection or reset
            state.franjaInicio = { id: slot.dataset.id, time: slot.dataset.time };
            state.franjaFin = null;
            timelineInstructions.textContent = `Hora de inicio: ${state.franjaInicio.time}. Ahora, selecciona la hora de fin.`;
        } else {
            // End selection
            const allSlots = Array.from(timelineSlots.querySelectorAll('.timeline-slot'));
            const startIndex = allSlots.findIndex(s => s.dataset.id === state.franjaInicio.id);
            const endIndex = allSlots.findIndex(s => s.dataset.id === slot.dataset.id);

            if (startIndex > endIndex) { // Swap if selected backwards
                [state.franjaInicio, state.franjaFin] = [{ id: slot.dataset.id, time: slot.dataset.time }, state.franjaInicio];
            } else {
                state.franjaFin = { id: slot.dataset.id, time: slot.dataset.time };
            }

            const rangeSlots = allSlots.slice(Math.min(startIndex, endIndex), Math.max(startIndex, endIndex) + 1);
            if(rangeSlots.some(s => s.classList.contains('reserved'))) {
                alert('El rango seleccionado incluye un horario no disponible. Por favor, elige un nuevo rango.');
                state.franjaInicio = null; state.franjaFin = null;
                timelineInstructions.textContent = `Selección inválida. Vuelve a seleccionar la hora de inicio.`;
            } else {
                 timelineInstructions.textContent = `Rango seleccionado: ${state.franjaInicio.time} - ${state.franjaFin.time}.`;
            }
        }

        // Update UI
        timelineSlots.querySelectorAll('.timeline-slot').forEach(s => s.classList.remove('selected', 'in-range'));
        if (state.franjaInicio) {
            const startSlot = timelineSlots.querySelector(`[data-id='${state.franjaInicio.id}']`);
            if (startSlot) startSlot.classList.add('selected');
        }
        if (state.franjaFin) {
            const endSlot = timelineSlots.querySelector(`[data-id='${state.franjaFin.id}']`);
            if (endSlot) endSlot.classList.add('selected');
            const allSlots = Array.from(timelineSlots.querySelectorAll('.timeline-slot'));
            const startIndex = allSlots.findIndex(s => s.dataset.id === state.franjaInicio.id);
            const endIndex = allSlots.findIndex(s => s.dataset.id === state.franjaFin.id);
            allSlots.slice(startIndex, endIndex + 1).forEach(s => s.classList.add('in-range'));
        }
        updateButtons();
    });

    nextBtn.addEventListener('click', async () => {
        if (state.currentStep === 1) {
            goToStep(2);
            activoList.innerHTML = '<div class="text-center p-4"><span class="loading loading-spinner"></span></div>';
            const activos = await api.getActivos(state.tipoActivo.id);
            render.activos(activos);
        } else if (state.currentStep === 2) {
            goToStep(3);
            timelineSlots.innerHTML = '<div class="text-center p-4"><span class="loading loading-spinner loading-lg"></span></div>';
            const disponibilidad = await api.getDisponibilidad(state.activo.id, state.fecha);
            render.timeline(disponibilidad);
        } else if (state.currentStep === 3) {
            goToStep(4);
            render.summary();
        }
    });

    prevBtn.addEventListener('click', () => {
        goToStep(state.currentStep - 1);
    });

    submitBtn.addEventListener('click', async () => {
        submitBtn.classList.add('btn-disabled', 'loading');
        try {
            const data = {
                activo_id: state.activo.id,
                fecha: state.fecha,
                franja_inicio_id: state.franjaInicio.id,
                franja_fin_id: state.franjaFin.id,
            };
            const result = await api.createReserva(data);
            if (result.status === 'success') {
                steps[4].innerHTML = `
                    <div class="text-center py-10">
                        <i class="fas fa-check-circle text-success text-5xl mb-4"></i>
                        <h3 class="text-2xl font-bold">¡Reserva Confirmada!</h3>
                        <p>Tu reserva para <strong>${state.activo.nombre}</strong> ha sido creada con éxito.</p>
                        <a href="{% url 'reservas:mis_reservas' %}" class="btn btn-primary mt-6">Ver Mis Reservas</a>
                    </div>
                `;
                prevBtn.classList.add('hidden');
                submitBtn.classList.add('hidden');
            } else {
                const errorMessage = typeof result === 'object' ? Object.values(result).flat().join(' ') : 'Ocurrió un error.';
                alert(`Error al crear la reserva: ${errorMessage}`);
            }
        } catch (err) {
            alert('Error de conexión al crear la reserva.');
        } finally {
            submitBtn.classList.remove('btn-disabled', 'loading');
        }
    });

    // --- INITIALIZATION ---
    async function init() {
        fechaInput.min = new Date().toISOString().split("T")[0];
        const tipos = await api.getTiposActivo();
        render.tiposActivo(tipos);
    }

    init();
});
</script>
{% endblock %}
