{% extends 'base.html' %}
{% load static %}

{% block title %}Disponibilidad de Equipos{% endblock %}

{% block extra_css %}
<style>
    .slot-button {
        transition: all 0.2s ease-in-out;
    }
    .slot-button.available:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .slot-selected {
        background-color: #3b82f6 !important; /* blue-600 */
        color: white;
        transform: scale(1.1);
    }
    .slot-in-range {
        background-color: #93c5fd !important; /* blue-300 */
        border-color: #3b82f6;
    }
    .slot-disabled {
        background-color: #f3f4f6; /* gray-100 */
        cursor: not-allowed;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Disponibilidad de Equipos</h1>
    <p class="text-gray-600 mb-6">Seleccione un rango de horas para reservar un equipo. Haga clic en la hora de inicio y luego en la hora de fin.</p>

    <!-- Date Filter Form -->
    <div class="bg-white p-4 rounded-lg shadow-md mb-6">
        <form method="get" action="{% url 'reservas:disponibilidad' %}" class="flex items-center space-x-4">
            <label for="fecha" class="font-semibold text-gray-700">Seleccionar fecha:</label>
            <input type="date" id="fecha" name="fecha" value="{{ fecha_seleccionada_str }}" class="border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Ver Disponibilidad
            </button>
        </form>
    </div>

    <!-- Availability Grid -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table id="availability-table" class="min-w-full border-collapse">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b sticky left-0 bg-gray-50 z-10 w-48">Equipo</th>
                    {% for turno_nombre, franjas_turno in turnos.items %}
                        {% if franjas_turno %}
                            <th colspan="{{ franjas_turno|length }}" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b bg-gray-100">{{ turno_nombre }}</th>
                        {% endif %}
                    {% endfor %}
                </tr>
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b sticky left-0 bg-gray-50 z-10 w-48">&nbsp;</th>
                    {% for franja in franjas %}
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-b">
                            {{ franja.hora_inicio|time:"H:i" }}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for item in grid %}
                <tr data-activo-id="{{ item.activo.id }}">
                    <td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900 border-b sticky left-0 bg-white z-10 w-48">{{ item.activo.nombre }}</td>
                    {% for slot in item.franjas %}
                        <td class="px-2 py-2 whitespace-nowrap text-center border-b" data-franja-id="{{ slot.franja.id }}">
                            {% if slot.reservado %}
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                    Reservado
                                </span>
                            {% else %}
                                <button class="w-full h-10 border border-gray-300 rounded-md bg-green-50 text-green-700 text-xs slot-button available"
                                        data-activo-id="{{ item.activo.id }}"
                                        data-franja-id="{{ slot.franja.id }}"
                                        data-franja-time="{{ slot.franja.hora_inicio|time:'H:i:s' }}">
                                    Disponible
                                </button>
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{{ franjas|length|add:1 }}" class="px-6 py-4 text-center text-gray-500">
                        No hay equipos disponibles para reservar.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Confirmation and Form Area -->
    <div id="confirmation-area" class="mt-8 bg-white p-6 rounded-lg shadow-md hidden">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Confirmar Reserva</h2>
        <p id="confirmation-text" class="text-gray-700 mb-4">Por favor, seleccione un rango de horas.</p>
        <form id="reserva-form" method="post" action="{% url 'reservas:disponibilidad' %}">
            {% csrf_token %}
            <input type="hidden" name="activo_id" id="form-activo-id">
            <input type="hidden" name="franja_id_inicio" id="form-franja-id-inicio">
            <input type="hidden" name="franja_id_fin" id="form-franja-id-fin">
            <input type="hidden" name="fecha" value="{{ fecha_seleccionada_str }}">

            <div class="flex items-center space-x-4">
                <button type="submit" id="confirm-button" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Confirmar Reserva
                </button>
                <button type="button" id="cancel-selection-button" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md hover:bg-gray-300">
                    Cancelar Selecci√≥n
                </button>
            </div>
        </form>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('availability-table');
    const confirmationArea = document.getElementById('confirmation-area');
    const confirmationText = document.getElementById('confirmation-text');
    const confirmButton = document.getElementById('confirm-button');
    const cancelSelectionButton = document.getElementById('cancel-selection-button');

    const formActivoId = document.getElementById('form-activo-id');
    const formFranjaIdInicio = document.getElementById('form-franja-id-inicio');
    const formFranjaIdFin = document.getElementById('form-franja-id-fin');

    let selection = {
        activoId: null,
        startFranjaId: null,
        endFranjaId: null,
        startFranjaTime: null,
        endFranjaTime: null,
        startElement: null,
    };

    function clearSelection() {
        if (selection.activoId) {
            const row = table.querySelector(`tr[data-activo-id="${selection.activoId}"]`);
            row.querySelectorAll('.slot-button').forEach(btn => {
                btn.classList.remove('slot-selected', 'slot-in-range', 'slot-disabled');
                if(btn.classList.contains('available')) {
                   btn.textContent = 'Disponible';
                }
            });
        }

        selection = {
            activoId: null,
            startFranjaId: null,
            endFranjaId: null,
            startFranjaTime: null,
            endFranjaTime: null,
            startElement: null,
        };

        confirmationArea.classList.add('hidden');
        confirmButton.disabled = true;
        confirmationText.textContent = 'Por favor, seleccione un rango de horas.';
    }

    function updateUI() {
        if (!selection.activoId) return;

        const row = table.querySelector(`tr[data-activo-id="${selection.activoId}"]`);
        if (!row) return;

        // Limpiar estilos previos en la fila
        row.querySelectorAll('.slot-button').forEach(btn => {
            btn.classList.remove('slot-selected', 'slot-in-range');
            if (btn.classList.contains('available')) {
                btn.textContent = 'Disponible';
            }
        });

        if (selection.startFranjaId) {
            const startBtn = row.querySelector(`button[data-franja-id="${selection.startFranjaId}"]`);
            if (startBtn) {
                startBtn.classList.add('slot-selected');
                startBtn.textContent = 'Inicio';
            }
        }

        if (selection.endFranjaId) {
             // Validar que el rango no contenga celdas reservadas
            const franjas = Array.from(row.querySelectorAll('.slot-button.available'));
            const startIndex = franjas.findIndex(btn => btn.dataset.franjaId === selection.startFranjaId);
            const endIndex = franjas.findIndex(btn => btn.dataset.franjaId === selection.endFranjaId);

            // Asegurarse de que el inicio es antes del fin
            const [minIdx, maxIdx] = [Math.min(startIndex, endIndex), Math.max(startIndex, endIndex)];

            for (let i = minIdx; i <= maxIdx; i++) {
                franjas[i].classList.add('slot-in-range');
            }

            const endBtn = row.querySelector(`button[data-franja-id="${selection.endFranjaId}"]`);
            if(endBtn) {
                endBtn.classList.add('slot-selected');
                endBtn.textContent = 'Fin';
            }
        }
    }


    table.addEventListener('click', function(e) {
        const target = e.target;
        if (!target.matches('.slot-button.available')) {
            return;
        }

        const clickedActivoId = target.dataset.activoId;
        const clickedFranjaId = target.dataset.franjaId;
        const clickedFranjaTime = target.dataset.franjaTime;

        // Si se hace clic en una fila diferente, se reinicia la selecci√≥n
        if (selection.activoId && selection.activoId !== clickedActivoId) {
            clearSelection();
        }

        confirmationArea.classList.remove('hidden');

        // Si no hay nada seleccionado, este es el inicio
        if (!selection.startFranjaId) {
            selection.activoId = clickedActivoId;
            selection.startFranjaId = clickedFranjaId;
            selection.startFranjaTime = clickedFranjaTime;
            selection.startElement = target;
            confirmationText.textContent = `Ha seleccionado el inicio. Ahora, por favor seleccione la hora de fin en la misma fila.`;
        } else { // Si ya hay un inicio, este es el fin
            // Validar que el rango no contenga celdas reservadas
            const row = table.querySelector(`tr[data-activo-id="${selection.activoId}"]`);
            const allSlotsInRow = Array.from(row.querySelectorAll('td'));
            const startSlotIndex = allSlotsInRow.findIndex(td => td.dataset.franjaId === selection.startFranjaId);
            const endSlotIndex = allSlotsInRow.findIndex(td => td.dataset.franjaId === clickedFranjaId);

            const [minIdx, maxIdx] = [Math.min(startSlotIndex, endSlotIndex), Math.max(startSlotIndex, endSlotIndex)];

            let hasConflict = false;
            for(let i = minIdx; i <= maxIdx; i++) {
                if (!allSlotsInRow[i].querySelector('.slot-button.available')) {
                    hasConflict = true;
                    break;
                }
            }

            if (hasConflict) {
                alert('El rango seleccionado incluye horarios que ya est√°n reservados. Por favor, elija otro rango.');
                clearSelection();
                return;
            }

            // Asignar inicio y fin correctos
            if (new Date('1970-01-01T' + clickedFranjaTime) < new Date('1970-01-01T' + selection.startFranjaTime)) {
                selection.endFranjaId = selection.startFranjaId;
                selection.endFranjaTime = selection.startFranjaTime;
                selection.startFranjaId = clickedFranjaId;
                selection.startFranjaTime = clickedFranjaTime;
            } else {
                selection.endFranjaId = clickedFranjaId;
                selection.endFranjaTime = clickedFranjaTime;
            }

            // Llenar el formulario y habilitar el bot√≥n
            formActivoId.value = selection.activoId;
            formFranjaIdInicio.value = selection.startFranjaId;
            formFranjaIdFin.value = selection.endFranjaId;
            confirmButton.disabled = false;

            const activoNombre = row.querySelector('td:first-child').textContent;
            confirmationText.textContent = `Reservar "${activoNombre}" desde las ${selection.startFranjaTime.substring(0,5)} hasta las ${selection.endFranjaTime.substring(0,5)}.`;
        }

        updateUI();
    });

    cancelSelectionButton.addEventListener('click', clearSelection);
});
</script>
{% endblock %}
