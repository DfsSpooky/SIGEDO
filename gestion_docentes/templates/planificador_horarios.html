{% extends 'base.html' %}
{% load template_extras %}
{% block title %}Planificador de Horarios{% endblock %}
{% block breadcrumb %}Planificador{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .drop-zone.conflict-cell { background-color: hsla(var(--er)/.2); outline: 2px dashed hsl(var(--er)); cursor: not-allowed; }
    .sortable-ghost { @apply bg-primary/30 border-2 border-primary opacity-70 rounded-lg; }
    .droppable-cell.sortable-drag-over { @apply bg-primary/10; }
    #trash-zone.sortable-drag-over { @apply bg-error/20 ring-2 ring-error; transform: scale(1.05); }
    .skeleton-loader { @apply animate-pulse bg-base-200 rounded-lg; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* SweetAlert2 Button Fix */
    .swal2-confirm {
        background-color: hsl(var(--p)) !important;
        color: hsl(var(--pc)) !important;
        border-radius: var(--rounded-btn, 0.5rem);
        padding: 0.75rem 1.5rem;
    }
    .swal2-cancel {
        background-color: transparent !important;
        color: hsl(var(--bc)) !important;
        border: 1px solid hsl(var(--bc) / 0.2) !important;
        border-radius: var(--rounded-btn, 0.5rem);
        padding: 0.75rem 1.5rem;
    }
    .swal2-confirm:hover, .swal2-cancel:hover {
        opacity: 0.9;
    }
</style>

<div class="card bg-base-100 shadow-xl">
    <div class="card-body">
        <!-- Step 1: Selection -->
        <div class="flex flex-wrap justify-between items-center mb-6 gap-4 border-b border-base-300 pb-6">
            <div>
                <h1 class="card-title text-3xl">Planificador de Horarios</h1>
                <p class="text-base-content/70">Semestre Activo: <span class="font-semibold text-primary">{{ semestre_activo.nombre }}</span></p>
            </div>
            
            <div class="flex items-center gap-4 p-2 bg-base-200 rounded-box">
                <div class="form-control">
                    <label class="label pb-1"><span class="label-text">Especialidad:</span></label>
                    <select id="especialidad" class="select select-bordered select-sm">
                        <option value="" disabled selected>-- Seleccione --</option>
                        {% for esp in especialidades %}
                        <option value="{{ esp.id }}" {% if especialidad_seleccionada_id == esp.id|stringformat:"s" %}selected{% endif %}>{{ esp.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="form-control">
                    <label class="label pb-1"><span class="label-text">Semestre:</span></label>
                    <select id="semestre_cursado" class="select select-bordered select-sm">
                        <option value="" disabled selected>-- Seleccione --</option>
                        {% for sem_num in semestres_validos %}
                        <option value="{{ sem_num }}" {% if semestre_seleccionado == sem_num|stringformat:"s" %}selected{% endif %}>Semestre {{ sem_num|roman }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 2: Workspace (hidden by default) -->
        <div id="planner-body" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mt-4">
                
                <main class="lg:col-span-3">
                    <div class="overflow-x-auto rounded-lg shadow-md border border-base-300/50">
                        <table class="table table-fixed w-full">
                            <thead class="bg-base-200">
                                <tr>
                                    <th class="w-32">Horas</th>
                                    {% for dia in dias_semana %}<th>{{ dia }}</th>{% endfor %}
                                </tr>
                            </thead>
                            <tbody id="schedule-grid">
                                <!-- Grid will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </main>
                
                <aside class="lg:col-span-1">
                    <div class="p-4 bg-base-100 rounded-box border border-base-300/50 shadow-lg h-full space-y-4 sticky top-24">
                        <div role="tablist" class="tabs tabs-boxed">
                            <a role="tab" class="tab tab-active" data-tab="manual">Manual</a>
                            <a role="tab" class="tab" data-tab="auto">Automático</a>
                        </div>

                        <!-- Manual Assignment Tab -->
                        <div id="tab-manual" class="tab-content active space-y-4">
                            <h3 class="font-bold text-lg">Cursos por Asignar</h3>
                            <p class="text-xs text-base-content/60 -mt-3">Arrastra un curso al horario para asignarlo.</p>
                            <input type="text" id="course-search-input" placeholder="Buscar curso..." class="input input-bordered input-sm w-full">
                            <div id="unassigned-courses-container" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                                <!-- Unassigned courses will be populated by JS -->
                            </div>
                            <div class="divider"></div>
                            <div id="trash-zone" class="p-4 text-center border-2 border-dashed border-base-300 rounded-box bg-base-200 text-base-content/70 min-h-[80px] flex flex-col justify-center items-center transition-all duration-300">
                                <i class="fas fa-trash-alt text-2xl mb-2"></i>
                                <p class="font-semibold text-sm">Arrastra aquí para desasignar</p>
                            </div>
                        </div>

                        <!-- Automatic Generator Tab -->
                        <div id="tab-auto" class="tab-content space-y-4">
                            <h3 class="font-bold text-lg">Generador Automático</h3>
                            <p class="text-xs text-base-content/60 -mt-3">Asigna automáticamente los cursos pendientes.</p>
                            <button id="auto-assign-btn" class="btn btn-primary w-full">
                                <i class="fas fa-magic"></i>
                                Generar Horario
                            </button>
                            <div class="divider"></div>
                            <h4 class="font-semibold">Registro de Actividad</h4>
                            <div id="auto-assign-log" class="text-xs p-2 bg-base-200 rounded-md h-48 overflow-y-auto font-mono">
                                Presiona "Generar Horario" para iniciar...
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Placeholder when no selection is made -->
        <div id="planner-placeholder" class="text-center py-20 text-base-content/50">
            <i class="fas fa-drafting-compass fa-4x mb-4"></i>
            <p class="text-xl font-semibold">Selecciona una especialidad y un semestre para comenzar a planificar.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Element Selectors
    const selectors = {
        especialidad: '#especialidad',
        semestre: '#semestre_cursado',
        plannerBody: '#planner-body',
        placeholder: '#planner-placeholder',
        grid: '#schedule-grid',
        unassignedContainer: '#unassigned-courses-container',
        trash: '#trash-zone',
        searchInput: '#course-search-input',
        autoAssignBtn: '#auto-assign-btn',
        autoAssignLog: '#auto-assign-log',
        tabs: '.tabs .tab'
    };
    const DOMElements = Object.fromEntries(Object.entries(selectors).map(([key, selector]) => [key, document.querySelector(selector)]));

    // Initial Data from Django
    const franjasHorarias = {{ franjas_horarias_json|safe }};
    const diasSemana = {{ dias_semana_json|safe }};

    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });

    // --- API & UTILITY FUNCTIONS ---
    async function callApi(url, method = 'GET', body = null) {
        const options = { method, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' } };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(url, options);
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || data.error || 'Error en el servidor');
        return data;
    }

    function log(message) {
        DOMElements.autoAssignLog.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
        DOMElements.autoAssignLog.scrollTop = DOMElements.autoAssignLog.scrollHeight;
    }

    // --- RENDERING FUNCTIONS ---
    function createCourseElement(curso, isAssigned = false) {
        const docenteNombre = `${curso.docente__first_name || ''} ${curso.docente__last_name || ''}`.trim();
        const div = document.createElement('div');
        div.className = `relative p-2 rounded-lg text-sm transition-all duration-300 cursor-grab active:cursor-grabbing border`;
        div.dataset.cursoId = curso.id;
        div.dataset.duracion = curso.duracion_bloques;
        div.dataset.fullData = JSON.stringify(curso);

        // 1. Color Coding based on course type
        let colors = '';
        if (curso.tipo_curso === 'GENERAL') {
            colors = 'bg-purple-500/10 border-purple-500/20 text-purple-800 dark:text-purple-300';
        } else { // ESPECIALIDAD
            colors = 'bg-sky-500/10 border-sky-500/20 text-sky-800 dark:text-sky-300';
        }
        // Unassigned courses have a neutral background
        if (!isAssigned) {
            colors = 'bg-base-200 border-base-300';
        }
        div.classList.add(...colors.split(' '));

        div.innerHTML = `
            <p class="font-bold truncate pr-4">${curso.nombre}</p>
            <p class="text-xs opacity-70 truncate">${docenteNombre}</p>
            <p class="text-xs opacity-50">${curso.duracion_bloques} bloque(s)</p>
        `;

        if (isAssigned) {
            const deleteButton = document.createElement('button');
            deleteButton.className = 'absolute top-1 right-1 btn btn-xs btn-circle btn-ghost text-error/50 hover:text-error hover:bg-error/10';
            deleteButton.innerHTML = `<i class="fas fa-times"></i>`;
            deleteButton.addEventListener('click', () => {
                Swal.fire({
                    title: '¿Desasignar curso?',
                    text: `"${curso.nombre}" volverá a la lista de pendientes.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, desasignar',
                    cancelButtonText: 'No'
                }).then((result) => {
                    if (result.isConfirmed) {
                        handleDeassign(div, div.parentElement);
                    }
                });
            });
            div.appendChild(deleteButton);
        }
        return div;
    }

    function renderPlanner(plannerData) {
        // 1. Render Grid
        DOMElements.grid.innerHTML = '';
        franjasHorarias.forEach(franja => {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="text-center text-xs font-medium text-base-content/60 align-top h-24 p-1 border-r border-base-300">${franja.hora_inicio.slice(0,5)} - ${franja.hora_fin.slice(0,5)}</td>`;
            diasSemana.forEach(dia => {
                row.innerHTML += `<td class="p-1 border-t border-r border-base-300 align-top relative drop-zone" data-dia="${dia}" data-franja-id="${franja.id}"></td>`;
            });
            DOMElements.grid.appendChild(row);
        });

        // 2. Render Unassigned Courses
        DOMElements.unassignedContainer.innerHTML = '';
        const { generales, especialidad } = plannerData.cursos_no_asignados;
        const createAccordion = (title, courses, id) => {
            const collapseDiv = document.createElement('div');
            collapseDiv.className = 'collapse collapse-arrow bg-base-200/50';
            collapseDiv.innerHTML = `<input type="checkbox" checked /><div class="collapse-title text-md font-medium">${title} (${courses.length})</div><div class="collapse-content"><div id="${id}" class="space-y-2 pt-2"></div></div>`;
            const courseList = collapseDiv.querySelector(`#${id}`);
            if (courses.length > 0) {
                courses.forEach(curso => courseList.appendChild(createCourseElement(curso, false)));
            } else {
                courseList.innerHTML = '<p class="text-xs text-base-content/50 p-2">No hay cursos.</p>';
            }
            return collapseDiv;
        };
        DOMElements.unassignedContainer.appendChild(createAccordion('Generales', generales, 'unassigned-generales'));
        DOMElements.unassignedContainer.appendChild(createAccordion('Especialidad', especialidad, 'unassigned-especialidad'));

        // 3. Render Assigned Courses
        plannerData.cursos_asignados.forEach(curso => {
            if (!curso.franja_id_inicio) return;
            const cell = document.querySelector(`#schedule-grid td[data-dia="${curso.dia}"][data-franja-id="${curso.franja_id_inicio}"]`);
            if (cell) {
                cell.appendChild(createCourseElement(curso, true));
                cell.setAttribute('rowspan', curso.duracion_bloques);
                let currentRow = cell.parentElement;
                for (let i = 1; i < curso.duracion_bloques; i++) {
                    currentRow = currentRow.nextElementSibling;
                    if (currentRow) {
                        const cellToHide = currentRow.querySelector(`[data-dia="${curso.dia}"]`);
                        if (cellToHide) cellToHide.style.display = 'none';
                    }
                }
            }
        });

        // 4. Re-initialize Drag and Drop
        initializeDragAndDrop();
    }

    // --- DRAG AND DROP LOGIC ---
    let sortableInstances = [];
    function initializeDragAndDrop() {
        sortableInstances.forEach(s => s.destroy());
        sortableInstances = [];

        const sharedConfig = { group: 'shared', animation: 150 };
        
        const onAdd = async (evt) => {
            const { item, to, from } = evt;
            revertVisualSpan(from, item.dataset.duracion);
            if (to.classList.contains('conflict-cell') || to.children.length > 1) {
                from.appendChild(item);
                return Toast.fire({ icon: 'error', title: 'No se puede asignar en este espacio.' });
            }
            try {
                const data = await callApi('/api/asignar-horario/', 'POST', { curso_id: item.dataset.cursoId, dia: to.dataset.dia, franja_id: to.dataset.franjaId });
                Toast.fire({ icon: 'success', title: data.message });
                applyVisualSpan(to, item.dataset.duracion);
                to.replaceChild(createCourseElement(JSON.parse(item.dataset.fullData), true), item);
            } catch (error) {
                Toast.fire({ icon: 'error', title: error.message });
                from.appendChild(item);
            }
        };

        const onStart = (evt) => highlightConflicts(evt.item.dataset.cursoId);
        const onEnd = () => clearConflicts();

        sortableInstances.push(new Sortable(document.getElementById('unassigned-generales'), sharedConfig));
        sortableInstances.push(new Sortable(document.getElementById('unassigned-especialidad'), sharedConfig));
        document.querySelectorAll('.drop-zone').forEach(zone => sortableInstances.push(new Sortable(zone, { ...sharedConfig, onAdd, onStart, onEnd })));

        sortableInstances.push(new Sortable(DOMElements.trash, {
            ...sharedConfig,
            onAdd: (evt) => handleDeassign(evt.item, evt.from)
        }));
    }

    async function handleDeassign(courseElement, fromCell = null) {
        const cursoId = courseElement.dataset.cursoId;
        if (!cursoId) return;

        try {
            await callApi('/api/desasignar-horario/', 'POST', { curso_id: cursoId });
            Toast.fire({ icon: 'info', title: 'Curso desasignado' });

            // If the element came from a cell, revert its span. Otherwise, just remove.
            if (fromCell) {
                revertVisualSpan(fromCell, courseElement.dataset.duracion);
            }
            courseElement.remove();

            // Reload all data to refresh the unassigned list correctly
            await loadPlannerData();
        } catch (error) {
            Toast.fire({ icon: 'error', title: `Error al desasignar: ${error.message}` });
            // If dragging failed, put it back. This part is tricky if not a drag op.
            if (fromCell) {
                fromCell.appendChild(courseElement);
            }
        }
    }

    async function highlightConflicts(cursoId) {
        clearConflicts();
        const data = await callApi(`/api/get-teacher-conflicts/?curso_id=${cursoId}`);
        data.conflicts.forEach(c => document.querySelector(`td[data-dia="${c.dia}"][data-franja-id="${c.franja_id}"]`)?.classList.add('conflict-cell'));
    }
    function clearConflicts() {
        document.querySelectorAll('.conflict-cell').forEach(c => c.classList.remove('conflict-cell'));
    }
    function applyVisualSpan(cell, duration) {
        if (!cell || duration < 2) return;
        cell.setAttribute('rowspan', duration);
        let currentRow = cell.parentElement;
        for (let i = 1; i < duration; i++) {
            currentRow = currentRow.nextElementSibling;
            if (currentRow) {
                const cellToHide = currentRow.querySelector(`[data-dia="${cell.dataset.dia}"]`);
                if (cellToHide) cellToHide.style.display = 'none';
            }
        }
    }

    function revertVisualSpan(cell, duration) {
        if (!cell || duration < 2) return;
        cell.setAttribute('rowspan', 1);
        let currentRow = cell.parentElement;
        for (let i = 1; i < duration; i++) {
            currentRow = currentRow.nextElementSibling;
            if (currentRow) {
                const cellToShow = currentRow.querySelector(`[data-dia="${cell.dataset.dia}"]`);
                if (cellToShow) cellToShow.style.display = '';
            }
        }
    }


    // --- EVENT HANDLERS & INITIALIZATION ---
    async function loadPlannerData() {
        const especialidadId = DOMElements.especialidad.value;
        const semestreNum = DOMElements.semestre.value;

        if (!especialidadId || !semestreNum) {
            DOMElements.plannerBody.classList.add('hidden');
            DOMElements.placeholder.classList.remove('hidden');
            return;
        }
        
        DOMElements.plannerBody.classList.remove('hidden');
        DOMElements.placeholder.classList.add('hidden');
        DOMElements.grid.innerHTML = `<tr><td colspan="${diasSemana.length + 1}"><div class="skeleton-loader h-96 w-full"></div></td></tr>`;
        DOMElements.unassignedContainer.innerHTML = '<div class="skeleton-loader h-16 w-full"></div>';

        try {
            const data = await callApi(`/api/get-cursos-no-asignados/?especialidad_id=${especialidadId}&semestre_cursado=${semestreNum}`);
            renderPlanner(data);
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Error al cargar datos', text: error.message });
        }
    }

    async function handleAutoAssign() {
        const especialidadId = DOMElements.especialidad.value;
        const semestreNum = DOMElements.semestre.value;
        if (!especialidadId || !semestreNum) {
            return Toast.fire({ icon: 'warning', title: 'Selecciona especialidad y semestre primero.' });
        }

        DOMElements.autoAssignBtn.classList.add('btn-disabled', 'loading');
        log('Iniciando proceso de asignación automática...');
        
        try {
            const data = await callApi('/api/auto-asignar/', 'POST', { especialidad_id: especialidadId, semestre_cursado: semestreNum });
            log(data.message);
            log('Actualizando la interfaz...');
            renderPlanner(data.plannerData);
            Toast.fire({ icon: 'success', title: 'Proceso completado!' });
        } catch (error) {
            log(`ERROR: ${error.message}`);
            Swal.fire({ icon: 'error', title: 'Error en Auto-Asignación', text: error.message });
        } finally {
            DOMElements.autoAssignBtn.classList.remove('btn-disabled', 'loading');
        }
    }

    DOMElements.especialidad.addEventListener('change', loadPlannerData);
    DOMElements.semestre.addEventListener('change', loadPlannerData);
    DOMElements.autoAssignBtn.addEventListener('click', handleAutoAssign);


    DOMElements.searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        document.querySelectorAll('#unassigned-courses-container > .collapse .p-2.rounded-lg').forEach(card => {
            card.style.display = card.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    });

    DOMElements.tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            DOMElements.tabs.forEach(t => t.classList.remove('tab-active'));
            tab.classList.add('tab-active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
        });
    });

    if (DOMElements.especialidad.value && DOMElements.semestre.value) {
        loadPlannerData();
    }
});
</script>

{% endblock %}